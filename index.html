<iframe id="spotifyFrame" width="50%" height="152" frameborder="0"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture">
</iframe>

<!-- Geen muziek melding -->
<p id="noMusicMessage" style="display: none; text-align: center; font-size: 18px; font-weight: bold; color: white;">
    ðŸŽµ Er speelt momenteel geen muziek op Spotify ðŸŽµ
</p>

<!-- Inlogknop -->
<button id="spotifyLogin" style="display: none; background-color: #1DB954; color: white; 
    border: none; padding: 10px 20px; font-size: 16px; font-weight: bold; 
    border-radius: 25px; cursor: pointer; margin-top: 20px;">
    ðŸ”‘ Inloggen bij Spotify
</button>

<script>
// âœ… Functie om een cookie in te stellen
function setCookie(name, value, days) {
    let expires = "";
    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + value + "; path=/" + expires;
}

// âœ… Functie om een cookie op te halen
function getCookie(name) {
    const cookies = document.cookie.split('; ');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].split('=');
        if (cookie[0] === name) {
            return cookie[1];
        }
    }
    return null;
}

// âœ… Functie om de token op te halen en op te slaan in een cookie
function getAccessToken() {
    const urlParams = new URLSearchParams(window.location.hash.substr(1));
    const token = urlParams.get("access_token");

    if (token) {
        console.log("âœ… Nieuw Spotify-token ontvangen:", token);
        setCookie("spotify_token", token, 1); // Token opslaan voor 1 dag
        window.location.hash = ""; // Verwijder token uit URL voor een schonere URL
        return token;
    }

    return getCookie("spotify_token"); // Ophalen van opgeslagen token
}

// âœ… Functie om door te sturen naar de Spotify inlogpagina
function redirectToSpotifyAuth() {
    console.log("ðŸ”‘ Gebruiker klikt op de inlogknop. Doorsturen naar Spotify...");
    const CLIENT_ID = "adfb40a14b7844eea65949e04c98fe11";
    const REDIRECT_URI = "https://AlbertjanPieffers.github.io/spotify-now-playing/";
    const SCOPES = "user-read-currently-playing";
    
    const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
    window.location.href = authUrl;
}

// âœ… Functie om te checken of Spotify momenteel muziek afspeelt
async function fetchSpotifyNowPlaying(token) {
    console.log("ðŸ” Controleren of Spotify momenteel muziek afspeelt...");

    try {
        const response = await fetch("https://api.spotify.com/v1/me/player/currently-playing", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });

        console.log(`ðŸ“¡ Spotify API Response Status: ${response.status}`);

        if (response.status === 401) { // Token is verlopen of gebruiker is niet ingelogd
            console.error("âš ï¸ Token verlopen of gebruiker niet ingelogd. Inlogknop tonen.");
            setCookie("spotify_token", "", -1); // Verwijder verlopen token
            document.getElementById("spotifyLogin").style.display = "block";
            document.getElementById("noMusicMessage").style.display = "none"; 
            return;
        }

        if (response.status === 204) { // Geen muziek speelt, maar gebruiker is WEL ingelogd
            console.log("ðŸŽµ Geen muziek speelt momenteel, maar gebruiker is ingelogd. Toon melding.");
            document.getElementById("spotifyLogin").style.display = "none";
            document.getElementById("spotifyFrame").style.display = "none";
            document.getElementById("noMusicMessage").style.display = "block";
            return;
        }

        if (!response.ok) { // Andere fout
            console.error(`âŒ Onverwachte fout bij ophalen Spotify data. Status: ${response.status}`);
            document.getElementById("spotifyLogin").style.display = "block";
            document.getElementById("noMusicMessage").style.display = "none";
            return;
        }

        const data = await response.json();
        console.log("âœ… Spotify API Response ontvangen:", data);

        if (data && data.item) {
            const trackId = data.item.id;
            console.log(`ðŸŽ¶ Nummer gevonden: ${data.item.name} - Embed Track: ${trackId}`);
            document.getElementById("spotifyFrame").src = `https://open.spotify.com/embed/track/${trackId}`;
            document.getElementById("spotifyFrame").style.display = "block";
            document.getElementById("spotifyLogin").style.display = "none";
            document.getElementById("noMusicMessage").style.display = "none";
        } else {
            console.warn("ðŸŽµ Geen nummer speelt momenteel, maar gebruiker is ingelogd.");
            document.getElementById("spotifyFrame").style.display = "none";
            document.getElementById("spotifyLogin").style.display = "none";
            document.getElementById("noMusicMessage").style.display = "block";
        }
    } catch (error) {
        console.error("âŒ Fout bij ophalen Spotify data:", error);
        document.getElementById("spotifyLogin").style.display = "block";
        document.getElementById("noMusicMessage").style.display = "none";
    }
}

// âœ… Token ophalen en checken
let token = getAccessToken();

if (!token) {
    console.warn("âš ï¸ Geen Spotify token gevonden. Inlogknop wordt weergegeven.");
    document.getElementById("spotifyLogin").style.display = "block";
    document.getElementById("noMusicMessage").style.display = "none";
} else {
    console.log("âœ… Token gevonden! Controleren of Spotify muziek afspeelt...");
    fetchSpotifyNowPlaying(token);
    setInterval(() => fetchSpotifyNowPlaying(token), 10000); // Update elke 10 seconden
}

// âœ… Maak de inlogknop functioneel
document.getElementById("spotifyLogin").addEventListener("click", redirectToSpotifyAuth);
</script>
